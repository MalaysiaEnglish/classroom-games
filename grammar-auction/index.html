<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grammar Auction</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #F5A623;
    --dark: #1A1A2E;
    --card: #16213E;
    --accent: #E94560;
    --green: #0F9B58;
    --text: #EEF2FF;
    --muted: #8892B0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--dark);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(245,166,35,0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(245,166,35,0.05) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }
  .wrapper { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 20px; }
  header { text-align: center; padding: 20px 0 14px; border-bottom: 2px solid rgba(245,166,35,0.3); margin-bottom: 24px; }
  header h1 { font-family: 'Bebas Neue', sans-serif; font-size: clamp(2.4rem, 6vw, 4.5rem); letter-spacing: 4px; color: var(--gold); line-height: 1; text-shadow: 0 0 40px rgba(245,166,35,0.4); }
  header p { color: var(--muted); font-size: 0.85rem; margin-top: 6px; letter-spacing: 1px; text-transform: uppercase; }
  .back-link { display: inline-block; margin-bottom: 16px; color: var(--muted); text-decoration: none; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; transition: color 0.2s; }
  .back-link:hover { color: var(--gold); }
  .screen { display: none; }
  .screen.active { display: block; }
  .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  @media (max-width: 640px) { .setup-grid { grid-template-columns: 1fr; } }
  .panel { background: var(--card); border: 1px solid rgba(245,166,35,0.2); border-radius: 12px; padding: 20px; }
  .panel h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 14px; }
  .team-entry { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
  .team-color-dot { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
  input[type="text"], input[type="number"] {
    background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px;
    color: var(--text); padding: 10px 14px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
    width: 100%; transition: border-color 0.2s;
  }
  input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--gold); }
  .sentences-area { grid-column: 1 / -1; }
  .sentence-list { list-style: none; display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; max-height: 240px; overflow-y: auto; padding-right: 4px; }
  .sentence-item { display: flex; align-items: flex-start; gap: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px 12px; font-size: 0.88rem; }
  .sentence-item .badge { font-family: 'Bebas Neue', sans-serif; font-size: 0.7rem; letter-spacing: 1px; padding: 3px 8px; border-radius: 20px; flex-shrink: 0; margin-top: 1px; }
  .badge.correct { background: rgba(15,155,88,0.25); color: #4ade80; border: 1px solid #4ade80; }
  .badge.incorrect { background: rgba(233,69,96,0.25); color: #f87171; border: 1px solid #f87171; }
  .sentence-text { flex: 1; line-height: 1.4; }
  .btn-remove { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; padding: 0 4px; line-height: 1; flex-shrink: 0; transition: color 0.2s; }
  .btn-remove:hover { color: var(--accent); }
  .add-sentence-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .add-sentence-row input[type="text"] { flex: 1; min-width: 180px; }
  .toggle-correct { display: flex; gap: 8px; }
  .radio-btn { flex: 1; padding: 9px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: var(--muted); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; text-align: center; transition: all 0.2s; white-space: nowrap; }
  .radio-btn.selected-correct { background: rgba(15,155,88,0.3); border-color: #4ade80; color: #4ade80; }
  .radio-btn.selected-incorrect { background: rgba(233,69,96,0.3); border-color: #f87171; color: #f87171; }
  .btn { padding: 11px 24px; border-radius: 8px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 0.92rem; letter-spacing: 0.5px; transition: all 0.2s; }
  .btn-gold { background: var(--gold); color: var(--dark); }
  .btn-gold:hover { background: #ffbe4d; transform: translateY(-1px); }
  .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text); }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold); }
  .btn-accent { background: var(--accent); color: white; }
  .btn-accent:hover { background: #ff6b87; }
  .btn-sm { padding: 7px 14px; font-size: 0.82rem; }
  .start-row { text-align: center; margin-top: 10px; }
  .scoreboard { display: flex; gap: 14px; margin-bottom: 24px; flex-wrap: wrap; }
  .team-card { flex: 1; min-width: 130px; background: var(--card); border: 2px solid transparent; border-radius: 12px; padding: 14px 16px; text-align: center; transition: all 0.3s; }
  .team-card .team-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; margin-bottom: 4px; }
  .team-card .team-budget { font-size: 1.7rem; font-weight: 700; color: var(--gold); line-height: 1; }
  .team-card .budget-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .team-card .bid-display { margin-top: 6px; font-size: 0.8rem; color: var(--muted); min-height: 18px; }
  .team-card .bid-display span { color: white; font-weight: 700; }
  .sentence-display { background: var(--card); border: 1px solid rgba(245,166,35,0.3); border-radius: 16px; padding: 28px 36px; text-align: center; margin-bottom: 20px; position: relative; min-height: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .sentence-number { position: absolute; top: 12px; left: 18px; font-family: 'Bebas Neue', sans-serif; font-size: 0.8rem; color: var(--muted); letter-spacing: 2px; }
  .sentence-display .main-sentence { font-size: clamp(1.2rem, 3vw, 1.9rem); font-weight: 500; line-height: 1.5; color: white; }
  .sentence-display .verdict { margin-top: 14px; font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 3px; display: none; }
  .verdict.correct { color: #4ade80; }
  .verdict.incorrect { color: var(--accent); }
  .bidding-area { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 18px; }
  .bidding-area h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 14px; }
  .bid-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin-bottom: 14px; }
  .bid-row { display: flex; flex-direction: column; gap: 5px; }
  .bid-row label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .bid-row .team-label { font-weight: 700; color: var(--text); font-size: 0.9rem; }
  .bid-controls { display: flex; gap: 5px; align-items: center; }
  .bid-controls input { width: 80px; text-align: center; font-size: 1rem; font-weight: 700; }
  .btn-bid-adj { width: 32px; height: 32px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.07); color: var(--text); cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
  .btn-bid-adj:hover { background: rgba(245,166,35,0.2); border-color: var(--gold); }
  .action-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .result-panel { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 12px 16px; margin-top: 10px; display: none; font-size: 0.88rem; line-height: 1.8; }
  .result-panel .winner-line { font-weight: 700; color: #4ade80; }
  .result-panel .loser-line { color: var(--accent); }
  .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 20px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--gold); border-radius: 2px; transition: width 0.4s ease; }
  .final-screen { text-align: center; padding: 32px 20px; }
  .final-screen h2 { font-family: 'Bebas Neue', sans-serif; font-size: clamp(2rem, 5vw, 3.8rem); letter-spacing: 4px; color: var(--gold); margin-bottom: 8px; }
  .final-podium { display: flex; justify-content: center; gap: 16px; margin: 28px 0; flex-wrap: wrap; }
  .podium-card { background: var(--card); border: 2px solid rgba(245,166,35,0.3); border-radius: 12px; padding: 20px 28px; min-width: 150px; }
  .podium-card.first { border-color: var(--gold); box-shadow: 0 0 30px rgba(245,166,35,0.3); transform: scale(1.05); }
  .podium-card .place { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; color: var(--gold); line-height: 1; }
  .podium-card .p-name { font-weight: 700; font-size: 1rem; margin: 6px 0 4px; }
  .podium-card .p-score { color: var(--gold); font-size: 1.3rem; font-weight: 700; }
  .podium-card .p-label { color: var(--muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
  .review-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.88rem; text-align: left; }
  .review-table th { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px; padding: 7px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .review-table td { padding: 9px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .review-table tr:last-child td { border-bottom: none; }
  .tag-correct { color: #4ade80; font-weight: 700; }
  .tag-incorrect { color: var(--accent); font-weight: 700; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.35s ease forwards; }
  @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.08); } 100% { transform: scale(1); opacity: 1; } }
  .pop { animation: pop 0.4s ease forwards; }
  .presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
  .preset-btn { padding: 5px 11px; border-radius: 20px; border: 1px solid rgba(245,166,35,0.4); background: transparent; color: var(--gold); font-size: 0.78rem; cursor: pointer; transition: all 0.2s; }
  .preset-btn:hover { background: rgba(245,166,35,0.15); }
  .info-tip { background: rgba(245,166,35,0.08); border: 1px solid rgba(245,166,35,0.2); border-radius: 8px; padding: 11px 14px; font-size: 0.83rem; color: var(--muted); margin-bottom: 18px; line-height: 1.6; }
  .info-tip strong { color: var(--gold); }
  .hidden { display: none !important; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
  ::-webkit-scrollbar-thumb { background: rgba(245,166,35,0.4); border-radius: 3px; }
    select, select option { background: #1a2a38 !important; color: white !important; }
  </style>
  <script src="../content.js" onerror="console.log('No content.js')"></script>
</head>
<body>
<div class="wrapper">
  <a href="../index.html" class="back-link">‚Üê Back to Games</a>
  <header>
    <h1>Grammar Auction</h1>
    <p>Bid on sentences ‚Äî win if you're right</p>
  </header>

  <!-- SETUP SCREEN -->
  <div id="setupScreen" class="screen active">
    <div class="info-tip">
      <strong>How to play:</strong> Each team gets a budget. A sentence is displayed ‚Äî teams bid points on whether it's correct English or not. Highest bid on the right answer wins those points back. Wrong bets lose money. Most money at the end wins!
    </div>

    <div class="setup-grid">
      <div class="panel">
        <h2>Teams</h2>
        <div id="teamsList"></div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-outline btn-sm" onclick="addTeam()">+ Add Team</button>
        </div>
        <div style="margin-top:14px;">
          <label style="font-size:0.78rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:6px;">Starting Budget</label>
          <input type="number" id="startBudget" value="1000" min="100" max="9999" step="100" style="width:130px;">
        </div>
      </div>

      <div class="panel sentences-area">
        <h2>Sentences</h2>
        <p style="color:var(--muted); font-size:0.82rem; margin-bottom:12px;">
          Tick one or more topics to combine them into a single game. Leave all unticked to use every sentence.
        </p>

        <!-- Topic filter UI -->
        <div id="topicFilterWrap" style="margin-bottom:14px;">

          <!-- Quick-select buttons, built dynamically -->
          <div id="unitQuickSelect" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;"></div>

          <!-- Checkbox list -->
          <div id="topicCheckboxes" style="
            display:flex; flex-wrap:wrap; gap:6px;
            padding:12px; border-radius:10px;
            border:1px solid rgba(255,255,255,0.1);
            background:rgba(255,255,255,0.04);
            max-height:220px; overflow-y:auto;
          "></div>

          <div style="display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm" onclick="selectAllTopics()">‚úÖ Select All</button>
            <button class="btn btn-outline btn-sm" onclick="clearAllTopics()">‚úñ Clear All</button>
            <button class="btn btn-outline btn-sm" onclick="shuffleSentences()">üîÄ Shuffle</button>
            <div id="filterStatus" style="font-size:0.82rem; color:var(--muted); margin-left:auto;"></div>
          </div>
        </div>

        <ul class="sentence-list" id="sentenceList"></ul>
      </div>
    </div>

    <div class="start-row">
      <button class="btn btn-gold" onclick="startGame()" style="font-size:1.05rem; padding:13px 44px; letter-spacing:1px;">START AUCTION</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="screen">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="scoreboard" id="scoreboard"></div>
    <div class="sentence-display fade-in" id="sentenceDisplay">
      <span class="sentence-number" id="sentenceNumber"></span>
      <div class="main-sentence" id="mainSentence"></div>
      <div class="verdict" id="verdictBadge"></div>
    </div>
    <div class="bidding-area">
      <h3>üí∞ Place Your Bids</h3>
      <div class="bid-grid" id="bidGrid"></div>
      <div class="action-row">
        <button class="btn btn-gold" onclick="revealVerdict()">REVEAL VERDICT</button>
        <button class="btn btn-outline hidden" id="nextBtn" onclick="nextSentence()">NEXT SENTENCE ‚Üí</button>
        <button class="btn btn-accent btn-sm hidden" id="endEarlyBtn" onclick="endGame()">End Game</button>
      </div>
      <div class="result-panel" id="resultPanel"></div>
    </div>
  </div>

  <!-- FINAL SCREEN -->
  <div id="finalScreen" class="screen">
    <div class="final-screen fade-in">
      <h2>üèÜ Final Results</h2>
      <p style="color:var(--muted);">The auction is over. Let's see who invested wisely...</p>
      <div class="final-podium" id="finalPodium"></div>
      <h3 style="font-family:'Bebas Neue',sans-serif; letter-spacing:2px; color:var(--gold); margin-bottom:10px;">Sentence Review</h3>
      <table class="review-table">
        <thead><tr><th>#</th><th>Sentence</th><th>Answer</th></tr></thead>
        <tbody id="reviewBody"></tbody>
      </table>
      <button class="btn btn-gold" onclick="resetToSetup()" style="margin-top:8px;">Play Again</button>
    </div>
  </div>
</div>

<script>
let teams = [];
let sentences = [];
let allSentences = [];  // full set from content.js
let currentSentenceIdx = 0;
let bids = {};
let sentenceType = 'correct';
let gameStartBudget = 1000;

const TEAM_COLORS = ['#F5A623','#E94560','#4FC3F7','#A78BFA','#4ade80','#FB923C'];

// ‚îÄ‚îÄ Load content.js sentences ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadContentSentences() {
  if (window.CUSTOM_CONTENT && window.CUSTOM_CONTENT.sentences) {
    allSentences = window.CUSTOM_CONTENT.sentences;
  } else {
    allSentences = [];
  }
  populateFilters();
  applyFilters();
}

function populateFilters() {
  const topics = [...new Set(allSentences.map(s => s.topic).filter(Boolean))].sort();

  // Build unit quick-select buttons (e.g. "S6/U6" groups all S6/U6/Lx topics)
  const unitGroups = {};
  topics.forEach(t => {
    const m = t.match(/^(S\d+\/U\d+)/);
    if (m) {
      const key = m[1];
      if (!unitGroups[key]) unitGroups[key] = [];
      unitGroups[key].push(t);
    }
  });

  const quickWrap = document.getElementById('unitQuickSelect');
  quickWrap.innerHTML = '';
  Object.keys(unitGroups).sort().forEach(unit => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline btn-sm';
    btn.textContent = `${unit} All`;
    btn.onclick = () => selectUnitTopics(unitGroups[unit]);
    quickWrap.appendChild(btn);
  });

  // Build checkboxes
  const wrap = document.getElementById('topicCheckboxes');
  wrap.innerHTML = '';
  topics.forEach(t => {
    const label = document.createElement('label');
    label.style.cssText = `
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:20px; cursor:pointer;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.05);
      font-size:0.8rem; color:var(--text);
      transition: all 0.15s; user-select:none;
    `;
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = t;
    cb.style.accentColor = '#F5A623';
    cb.addEventListener('change', applyFilters);
    label.appendChild(cb);
    label.appendChild(document.createTextNode(t));
    label.addEventListener('mouseenter', () => label.style.borderColor = 'rgba(245,166,35,0.4)');
    label.addEventListener('mouseleave', () => label.style.borderColor = 'rgba(255,255,255,0.12)');
    wrap.appendChild(label);
  });
}

function getCheckedTopics() {
  return [...document.querySelectorAll('#topicCheckboxes input[type=checkbox]:checked')]
    .map(cb => cb.value);
}

function selectAllTopics() {
  document.querySelectorAll('#topicCheckboxes input[type=checkbox]')
    .forEach(cb => cb.checked = true);
  applyFilters();
}

function clearAllTopics() {
  document.querySelectorAll('#topicCheckboxes input[type=checkbox]')
    .forEach(cb => cb.checked = false);
  applyFilters();
}

function selectUnitTopics(topicsForUnit) {
  // Clear all first, then tick only this unit's topics
  document.querySelectorAll('#topicCheckboxes input[type=checkbox]')
    .forEach(cb => { cb.checked = topicsForUnit.includes(cb.value); });
  applyFilters();
}

function applyFilters() {
  const checked = getCheckedTopics();
  sentences = checked.length === 0
    ? [...allSentences]
    : allSentences.filter(s => checked.includes(s.topic));

  // Highlight active checkboxes
  document.querySelectorAll('#topicCheckboxes label').forEach(label => {
    const cb = label.querySelector('input');
    label.style.background = cb.checked
      ? 'rgba(245,166,35,0.15)'
      : 'rgba(255,255,255,0.05)';
    label.style.borderColor = cb.checked
      ? 'rgba(245,166,35,0.5)'
      : 'rgba(255,255,255,0.12)';
  });

  const status = document.getElementById('filterStatus');
  if (status) {
    const topicCount = checked.length;
    status.textContent = sentences.length > 0
      ? `${sentences.length} sentence${sentences.length !== 1 ? 's' : ''} loaded${topicCount > 0 ? ` from ${topicCount} topic${topicCount > 1 ? 's' : ''}` : ' (all topics)'}`
      : 'No sentences match ‚Äî try a different selection';
    status.style.color = sentences.length > 0 ? '#4ade80' : '#ef4444';
  }
  renderSentenceList();
}

function renderSentenceList() {
  const ul = document.getElementById('sentenceList');
  if (!ul) return;
  ul.innerHTML = '';
  sentences.forEach(s => {
    const li = document.createElement('li');
    li.className = 'sentence-item';
    const badgeStyle = s.correct
      ? 'background:rgba(74,222,128,0.15);color:#4ade80'
      : 'background:rgba(239,68,68,0.15);color:#ef4444';
    li.innerHTML = `
      <span class="badge" style="${badgeStyle}">${s.correct ? 'CORRECT' : 'INCORRECT'}</span>
      <span>${s.text}</span>
    `;
    ul.appendChild(li);
  });
}

function shuffleSentences() {
  sentences = sentences.sort(() => Math.random() - 0.5);
  renderSentenceList();
}

function init() {
  teams = ['Team 1','Team 2','Team 3'].map((name, i) => ({ name, color: TEAM_COLORS[i], id: i }));
  renderTeamsList();
  loadContentSentences();
}

function renderTeamsList() {
  const list = document.getElementById('teamsList');
  list.innerHTML = '';
  teams.forEach((team, i) => {
    const row = document.createElement('div');
    row.className = 'team-entry';
    row.innerHTML = `
      <div class="team-color-dot" style="background:${team.color}"></div>
      <input type="text" value="${team.name}" oninput="teams[${i}].name=this.value" style="flex:1;">
      ${teams.length > 2 ? `<button class="btn-remove" onclick="removeTeam(${i})">√ó</button>` : ''}
    `;
    list.appendChild(row);
  });
}

function addTeam() {
  if (teams.length >= 6) return;
  teams.push({ name: `Team ${teams.length+1}`, color: TEAM_COLORS[teams.length % TEAM_COLORS.length], id: Date.now() });
  renderTeamsList();
}

function removeTeam(i) {
  if (teams.length <= 2) return;
  teams.splice(i, 1);
  renderTeamsList();
}

function startGame() {
  if (sentences.length < 2) { alert('Please select a topic with at least 2 sentences!'); return; }
  gameStartBudget = parseInt(document.getElementById('startBudget').value) || 1000;
  teams.forEach(t => { t.budget = gameStartBudget; });
  currentSentenceIdx = 0;
  showScreen('gameScreen');
  renderScoreboard();
  loadSentence();
}

function renderScoreboard() {
  const sb = document.getElementById('scoreboard');
  sb.innerHTML = '';
  teams.forEach(t => {
    const card = document.createElement('div');
    card.className = 'team-card';
    card.id = `teamCard_${t.id}`;
    card.style.borderColor = `rgba(${hexToRgb(t.color)},0.3)`;
    card.innerHTML = `
      <div class="team-name" style="color:${t.color}">${t.name}</div>
      <div class="team-budget" id="budget_${t.id}">¬£${t.budget}</div>
      <div class="budget-label">budget</div>
      <div class="bid-display" id="bidDisplay_${t.id}"></div>
    `;
    sb.appendChild(card);
  });
}

function loadSentence() {
  const s = sentences[currentSentenceIdx];
  document.getElementById('progressFill').style.width = `${(currentSentenceIdx/sentences.length)*100}%`;
  document.getElementById('sentenceNumber').textContent = `Sentence ${currentSentenceIdx+1} of ${sentences.length}`;
  document.getElementById('mainSentence').textContent = `"${s.text}"`;
  const verdict = document.getElementById('verdictBadge');
  verdict.style.display = 'none';
  verdict.className = 'verdict';
  document.getElementById('resultPanel').style.display = 'none';
  document.getElementById('nextBtn').classList.add('hidden');
  document.getElementById('endEarlyBtn').classList.add('hidden');
  teams.forEach(t => { document.getElementById(`bidDisplay_${t.id}`).innerHTML = ''; });
  renderBidGrid();
}

function renderBidGrid() {
  const grid = document.getElementById('bidGrid');
  grid.innerHTML = '';
  bids = {};
  teams.forEach(t => {
    bids[t.id] = { correct: 0, incorrect: 0 };
    const col = document.createElement('div');
    col.className = 'bid-row';
    col.innerHTML = `
      <span class="team-label" style="color:${t.color}">${t.name}</span>
      <label>Bid on ‚úì Correct</label>
      <div class="bid-controls">
        <button class="btn-bid-adj" onclick="adjustBid(${t.id},'correct',-50)">‚àí</button>
        <input type="number" id="bid_${t.id}_correct" value="0" min="0" max="${t.budget}" step="50" oninput="updateBidDisplay(${t.id})">
        <button class="btn-bid-adj" onclick="adjustBid(${t.id},'correct',50)">+</button>
      </div>
      <label>Bid on ‚úó Wrong</label>
      <div class="bid-controls">
        <button class="btn-bid-adj" onclick="adjustBid(${t.id},'incorrect',-50)">‚àí</button>
        <input type="number" id="bid_${t.id}_incorrect" value="0" min="0" max="${t.budget}" step="50" oninput="updateBidDisplay(${t.id})">
        <button class="btn-bid-adj" onclick="adjustBid(${t.id},'incorrect',50)">+</button>
      </div>
    `;
    grid.appendChild(col);
  });
}

function adjustBid(teamId, type, delta) {
  const input = document.getElementById(`bid_${teamId}_${type}`);
  const team = teams.find(t => t.id === teamId);
  let val = Math.max(0, Math.min(team.budget, (parseInt(input.value) || 0) + delta));
  input.value = val;
  updateBidDisplay(teamId);
}

function updateBidDisplay(teamId) {
  const c = parseInt(document.getElementById(`bid_${teamId}_correct`)?.value) || 0;
  const w = parseInt(document.getElementById(`bid_${teamId}_incorrect`)?.value) || 0;
  const disp = document.getElementById(`bidDisplay_${teamId}`);
  if (!disp) return;
  let parts = [];
  if (c > 0) parts.push(`<span>¬£${c}</span> on ‚úì`);
  if (w > 0) parts.push(`<span>¬£${w}</span> on ‚úó`);
  disp.innerHTML = parts.join(' ¬∑ ');
}

function revealVerdict() {
  const s = sentences[currentSentenceIdx];
  const verdict = document.getElementById('verdictBadge');
  verdict.textContent = s.correct ? '‚úì CORRECT ENGLISH' : '‚úó INCORRECT ENGLISH';
  verdict.className = 'verdict ' + (s.correct ? 'correct' : 'incorrect');
  verdict.style.display = 'block';
  verdict.classList.add('pop');

  const resultLines = [];
  teams.forEach(t => {
    const bidCorrect = parseInt(document.getElementById(`bid_${t.id}_correct`)?.value) || 0;
    const bidIncorrect = parseInt(document.getElementById(`bid_${t.id}_incorrect`)?.value) || 0;
    let change = s.correct ? (bidCorrect - bidIncorrect) : (bidIncorrect - bidCorrect);
    t.budget = Math.max(0, t.budget + change);
    document.getElementById(`budget_${t.id}`).textContent = `¬£${t.budget}`;
    if (change > 0) resultLines.push(`<div class="winner-line">üéâ ${t.name}: +¬£${change} ‚Üí ¬£${t.budget}</div>`);
    else if (change < 0) resultLines.push(`<div class="loser-line">üí∏ ${t.name}: ‚àí¬£${Math.abs(change)} ‚Üí ¬£${t.budget}</div>`);
    else resultLines.push(`<div style="color:var(--muted)">${t.name}: no bid ‚Üí ¬£${t.budget}</div>`);
  });

  const panel = document.getElementById('resultPanel');
  panel.innerHTML = resultLines.join('');
  panel.style.display = 'block';
  document.getElementById('nextBtn').classList.remove('hidden');
  if (currentSentenceIdx < sentences.length - 2) document.getElementById('endEarlyBtn').classList.remove('hidden');
}

function nextSentence() {
  currentSentenceIdx++;
  if (currentSentenceIdx >= sentences.length) { endGame(); return; }
  loadSentence();
}

function endGame() {
  document.getElementById('progressFill').style.width = '100%';
  showScreen('finalScreen');
  const sorted = [...teams].sort((a,b) => b.budget - a.budget);
  const medals = ['ü•á','ü•à','ü•â'];
  const podium = document.getElementById('finalPodium');
  podium.innerHTML = '';
  sorted.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'podium-card fade-in' + (i===0 ? ' first' : '');
    card.style.animationDelay = `${i*0.1}s`;
    card.innerHTML = `<div class="place">${medals[i]||i+1}</div><div class="p-name" style="color:${t.color}">${t.name}</div><div class="p-score">¬£${t.budget}</div><div class="p-label">final budget</div>`;
    podium.appendChild(card);
  });
  const tbody = document.getElementById('reviewBody');
  tbody.innerHTML = '';
  sentences.slice(0, currentSentenceIdx + 1).forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="color:var(--muted)">${i+1}</td><td>${s.text}</td><td class="${s.correct?'tag-correct':'tag-incorrect'}">${s.correct?'‚úì Correct':'‚úó Incorrect'}</td>`;
    tbody.appendChild(tr);
  });
}

function resetToSetup() { showScreen('setupScreen'); }
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function hexToRgb(hex) {
  return `${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)}`;
}

init();
</script>
</body>
</html>
