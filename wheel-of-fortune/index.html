<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wheel of Fortune</title>
  <link rel="stylesheet" href="../style.css">
  <script src="../content.js" onerror="console.log('No content.js')"></script>
  <style>
    /* â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-setup { display:flex; flex-direction:column; align-items:center; gap:20px; max-width:560px; margin:0 auto; }
    .picker-label { font-size:0.78rem; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:var(--accent); text-align:center; margin-bottom:7px; }
    .picker-row   { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .team-inputs  { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; }
    .team-input-group { display:flex; flex-direction:column; gap:5px; flex:1; min-width:120px; max-width:160px; align-items:center; }
    .team-input-group label { font-size:0.72rem; font-weight:800; text-transform:uppercase; }
    .team-input-group input { width:100%; padding:8px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(255,255,255,0.08); color:white; font-size:0.9rem; text-align:center; }
    select, select option { background:#1a2a38; color:white; }

    /* â”€â”€ Game layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-game        { display:none; flex-direction:column; align-items:center; gap:12px; width:100%; }
    .wof-game.active { display:flex; }

    /* â”€â”€ Phrase board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-phrase-area {
      width:100%; max-width:700px;
      background:var(--glass); border:1px solid var(--glass-border);
      border-radius:14px; padding:16px 12px;
    }
    .wof-category { font-size:0.72rem; font-weight:800; text-transform:uppercase; letter-spacing:0.12em; color:var(--accent); text-align:center; margin-bottom:10px; }
    .wof-board {
      display:flex; flex-wrap:wrap; gap:5px;
      justify-content:center; min-height:54px;
    }
    .wof-word { display:flex; gap:3px; margin:2px 4px; }
    .wof-tile {
      width:clamp(22px,5vw,36px); height:clamp(28px,6vw,44px);
      border-radius:5px; display:flex; align-items:center; justify-content:center;
      font-size:clamp(0.75rem,2.5vw,1.2rem); font-weight:900;
      border:2px solid rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.08);
      transition:all 0.3s;
      position:relative;
    }
    .wof-tile.revealed {
      background:white; color:#0f2027;
      border-color:white;
      animation:tileFlip 0.4s ease both;
    }
    @keyframes tileFlip {
      0%   { transform:rotateY(90deg); opacity:0; }
      100% { transform:rotateY(0deg);  opacity:1; }
    }
    .wof-tile.solved { background:var(--accent); color:#000; border-color:var(--accent); }

    /* â”€â”€ Wheel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-wheel-area { position:relative; display:flex; align-items:center; justify-content:center; }
    #wheelCanvas { display:block; border-radius:50%; filter:drop-shadow(0 0 18px rgba(0,201,167,0.4)); cursor:pointer; }
    .wheel-pointer {
      position:absolute; top:-2px; left:50%; transform:translateX(-50%);
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:28px solid #f7b731;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,0.6));
      z-index:10;
    }

    /* â”€â”€ Spin button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-spin-btn {
      padding:12px 36px; font-size:1.05rem; font-weight:900;
      background:linear-gradient(135deg,var(--accent),#00a88c);
      color:#000; border:none; border-radius:12px;
      cursor:pointer; letter-spacing:0.06em;
      transition:all 0.2s; box-shadow:0 4px 16px rgba(0,201,167,0.4);
    }
    .wof-spin-btn:hover:not(:disabled) { transform:scale(1.05); box-shadow:0 6px 24px rgba(0,201,167,0.6); }
    .wof-spin-btn:disabled { opacity:0.4; cursor:default; transform:none; }

    /* â”€â”€ Result banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-result {
      font-size:clamp(1.1rem,3.5vw,1.8rem); font-weight:900;
      padding:10px 24px; border-radius:12px; text-align:center;
      min-width:220px; letter-spacing:0.05em;
      animation:resultPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes resultPop { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }
    .result-points  { background:rgba(0,201,167,0.2); border:2px solid var(--accent); color:var(--accent); }
    .result-bankrupt{ background:rgba(239,68,68,0.2);  border:2px solid #ef4444; color:#ef4444; }
    .result-lose    { background:rgba(156,163,175,0.2);border:2px solid #9ca3af; color:#9ca3af; }
    .result-free    { background:rgba(251,191,36,0.2); border:2px solid #fbbf24; color:#fbbf24; }
    .result-double  { background:rgba(168,85,247,0.2); border:2px solid #a855f7; color:#a855f7; }

    /* â”€â”€ Letter picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-letters {
      display:flex; flex-wrap:wrap; gap:5px;
      justify-content:center; max-width:600px;
    }
    .wof-letter-btn {
      width:clamp(30px,6vw,44px); height:clamp(30px,6vw,44px);
      border-radius:8px; border:1px solid var(--glass-border);
      background:var(--glass); color:white;
      font-weight:900; font-size:clamp(0.75rem,2vw,1rem);
      cursor:pointer; transition:all 0.15s;
      display:flex; align-items:center; justify-content:center;
    }
    .wof-letter-btn:hover:not(:disabled) { background:var(--accent); color:#000; border-color:var(--accent); transform:scale(1.1); }
    .wof-letter-btn:disabled { opacity:0.2; cursor:default; transform:none; }
    .wof-letter-btn.used-hit  { background:rgba(0,201,167,0.3); border-color:var(--accent); color:var(--accent); opacity:0.5; }
    .wof-letter-btn.used-miss { background:rgba(239,68,68,0.15); border-color:#ef4444; color:#ef4444; opacity:0.4; }

    /* â”€â”€ Guess phrase input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-guess-row {
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center; width:100%; max-width:580px;
    }
    .wof-guess-row input {
      flex:1; min-width:200px; padding:10px 14px;
      border-radius:10px; border:1px solid var(--accent);
      background:rgba(0,201,167,0.08); color:white;
      font-size:1rem; font-weight:700;
    }
    .wof-guess-row input::placeholder { color:rgba(255,255,255,0.35); }
    .btn-guess {
      padding:10px 20px; border-radius:10px; border:none;
      background:var(--accent2); color:#000;
      font-weight:900; font-size:0.9rem; cursor:pointer; transition:all 0.2s;
    }
    .btn-guess:hover { filter:brightness(1.1); }

    /* â”€â”€ Score cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-scores { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; width:100%; }
    .wof-score-card {
      flex:1; min-width:100px; max-width:160px;
      background:var(--glass); border:2px solid var(--glass-border);
      border-radius:12px; padding:8px 12px; text-align:center; transition:all 0.3s;
    }
    .wof-score-card.current { border-color:var(--accent); background:var(--glass-hi); }
    .sc-name  { font-weight:800; font-size:0.82rem; margin-bottom:2px; }
    .sc-round { font-size:1.4rem; font-weight:900; color:var(--accent); }
    .sc-total { font-size:0.72rem; color:var(--text-dim); }
    .sc-bank  { font-size:0.78rem; color:var(--accent2); font-weight:700; }

    /* â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-status {
      font-size:clamp(0.9rem,2.5vw,1.2rem); font-weight:800;
      padding:9px 20px; border-radius:12px;
      background:var(--glass-hi); border:1px solid var(--glass-border);
      text-align:center; transition:color 0.3s;
    }

    /* â”€â”€ Win overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wof-win-overlay {
      position:fixed; inset:0; z-index:500;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.8);
    }
    .win-box {
      background:var(--glass-hi); border:2px solid var(--accent2);
      border-radius:20px; padding:32px 40px; text-align:center;
      animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes popIn { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }
    .win-box .w-emoji { font-size:3.5rem; }
    .win-box h2 { font-size:clamp(1.6rem,5vw,2.8rem); font-weight:900; color:var(--accent2); margin:8px 0; }
    .win-box p  { color:var(--text-dim); margin-bottom:18px; }
  </style>
</head>

<body class="hangman-page">
  <h1>ğŸ¡ Wheel of Fortune</h1>
  <div class="controls">
    <button id="newGameBtn">New Game</button>
    <button onclick="document.documentElement.requestFullscreen?.()">Fullscreen</button>
    <button onclick="window.location.href='../index.html'">Home</button>
  </div>

  <div class="game-wrapper">

    <!-- â•â• SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="setupScreen" class="wof-setup">
      <div style="font-size:4rem;text-align:center;">ğŸ¡</div>

      <div style="width:100%">
        <div class="picker-label">Number of Teams</div>
        <div class="picker-row" id="teamCountPicker">
          <button class="controls-btn hm-selected" data-n="2">2</button>
          <button class="controls-btn" data-n="3">3</button>
          <button class="controls-btn" data-n="4">4</button>
        </div>
      </div>

      <div style="width:100%" id="teamNamesSection">
        <div class="picker-label">Team Names</div>
        <div class="team-inputs" id="teamInputs"></div>
      </div>

      <div style="width:100%">
        <div class="picker-label">Word/Phrase Topic</div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;">
          <select id="topicSelect" style="padding:9px 14px;border-radius:8px;font-size:0.92rem;min-width:200px;">
            <option value="">All Topics</option>
          </select>
        </div>
        <div id="topicPreview" style="text-align:center;font-size:0.8rem;color:var(--text-dim);margin-top:8px;"></div>
      </div>

      <button id="startBtn" style="font-size:1.1rem;padding:14px 48px;background:var(--accent);color:#000;border:none;border-radius:12px;font-weight:900;cursor:pointer;letter-spacing:0.05em;">
        ğŸ¡ SPIN TO WIN
      </button>
    </div>

    <!-- â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="gameScreen" class="wof-game">

      <!-- Phrase board -->
      <div class="wof-phrase-area">
        <div class="wof-category" id="phraseCategory">Category</div>
        <div class="wof-board"    id="phraseBoard"></div>
      </div>

      <!-- Score cards -->
      <div class="wof-scores" id="scoreCards"></div>

      <!-- Status -->
      <div class="wof-status" id="statusBar">Ready</div>

      <!-- Wheel -->
      <div class="wof-wheel-area">
        <div class="wheel-pointer"></div>
        <canvas id="wheelCanvas" width="280" height="280"></canvas>
      </div>

      <!-- Spin button + result -->
      <button class="wof-spin-btn" id="spinBtn" onclick="spinWheel()">ğŸ¡ SPIN</button>
      <div id="resultBanner" style="display:none;"></div>

      <!-- Letter picker (shown after spin lands on points) -->
      <div id="letterSection" style="display:none;">
        <div style="font-size:0.78rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);text-align:center;margin-bottom:8px;">Pick a Letter</div>
        <div class="wof-letters" id="letterBtns"></div>
      </div>

      <!-- Guess the phrase -->
      <div id="guessSection" style="display:none;">
        <div style="font-size:0.78rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent2);text-align:center;margin-bottom:8px;">
          ğŸ¯ Guess the Phrase (bonus points!) â€” or just spin again
        </div>
        <div class="wof-guess-row">
          <input type="text" id="guessInput" placeholder="Type the full phraseâ€¦" onkeydown="if(event.key==='Enter')submitGuess()">
          <button class="btn-guess" onclick="submitGuess()">Guess!</button>
        </div>
      </div>

    </div>

  </div><!-- game-wrapper -->

  <!-- Win overlay -->
  <div id="winOverlay" class="wof-win-overlay" style="display:none;">
    <div class="win-box">
      <div class="w-emoji">ğŸ†</div>
      <h2 id="winMsg">Team 1 Wins!</h2>
      <p id="winDetail"></p>
      <button onclick="newPhrase()" style="padding:11px 28px;background:var(--accent);color:#000;border:none;border-radius:10px;font-weight:900;cursor:pointer;font-size:1rem;margin-right:8px;">Next Phrase</button>
      <button onclick="showSetup()" style="padding:11px 24px;background:var(--glass);border:1px solid var(--glass-border);color:white;border-radius:10px;font-weight:700;cursor:pointer;font-size:1rem;">New Game</button>
    </div>
  </div>

  <script>
    // â”€â”€ Wheel segments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SEGMENTS = [
      { label:'Â£100',   value:100,    color:'#1e3a5f', type:'points' },
      { label:'Â£300',   value:300,    color:'#1a5c2a', type:'points' },
      { label:'Â£200',   value:200,    color:'#3b1f6b', type:'points' },
      { label:'BANKRUPT',value:0,     color:'#7f1d1d', type:'bankrupt' },
      { label:'Â£500',   value:500,    color:'#0f4c75', type:'points' },
      { label:'Â£400',   value:400,    color:'#065f46', type:'points' },
      { label:'FREE\nSPIN',value:0,   color:'#1c4532', type:'freespin' },
      { label:'Â£750',   value:750,    color:'#312e81', type:'points' },
      { label:'Â£200',   value:200,    color:'#3b1f6b', type:'points' },
      { label:'LOSE\nTURN',value:0,   color:'#374151', type:'loseturn' },
      { label:'Â£300',   value:300,    color:'#1a5c2a', type:'points' },
      { label:'Â£1000',  value:1000,   color:'#92400e', type:'points' },
      { label:'Â£100',   value:100,    color:'#1e3a5f', type:'points' },
      { label:'Â£400',   value:400,    color:'#065f46', type:'points' },
      { label:'DOUBLE!',value:0,      color:'#6b21a8', type:'double' },
      { label:'Â£500',   value:500,    color:'#0f4c75', type:'points' },
    ];
    const N = SEGMENTS.length;
    const SLICE = (2 * Math.PI) / N;

    const TEAM_COLORS = ['#00c9a7','#f7b731','#e74c3c','#a29bfe'];
    const TEAM_NAMES_DEFAULT = ['Team 1','Team 2','Team 3','Team 4'];

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let numTeams = 2, teams = [], currentTeam = 0;
    let phrase = '', usedLetters = new Set(), phrasePool = [];
    let currentWheelValue = 0, currentWheelType = '', spinning = false;
    let hasFreeSpinStored = false;
    let gameStarted = false;

    // â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let selTeams = 2;
    document.querySelectorAll('#teamCountPicker button').forEach(b => {
      b.onclick = () => {
        document.querySelectorAll('#teamCountPicker button').forEach(x => x.classList.remove('hm-selected'));
        b.classList.add('hm-selected');
        selTeams = +b.dataset.n;
        buildTeamInputs();
      };
    });

    function buildTeamInputs() {
      const el = document.getElementById('teamInputs');
      el.innerHTML = '';
      for (let i = 0; i < selTeams; i++) {
        const g = document.createElement('div'); g.className = 'team-input-group';
        g.innerHTML = `<div style="width:12px;height:12px;border-radius:50%;background:${TEAM_COLORS[i]};margin-bottom:3px;"></div>
          <label style="color:${TEAM_COLORS[i]}">Team ${i+1}</label>
          <input type="text" id="tname${i}" value="Team ${i+1}">`;
        el.appendChild(g);
      }
    }
    buildTeamInputs();

    // Load topics from content.js
    function loadTopics() {
      const sel = document.getElementById('topicSelect');
      const words = window.CUSTOM_CONTENT?.words || [];
      const topics = [...new Set(words.map(w => w.topic).filter(Boolean))].sort();
      topics.forEach(t => {
        const opt = document.createElement('option'); opt.value = t; opt.textContent = t; sel.appendChild(opt);
      });
      sel.addEventListener('change', previewTopic);
      previewTopic();
    }

    function previewTopic() {
      const topic = document.getElementById('topicSelect').value;
      const words = window.CUSTOM_CONTENT?.words || [];
      const pool = words.filter(w => !topic || w.topic === topic);
      document.getElementById('topicPreview').textContent =
        pool.length ? `${pool.length} word${pool.length!==1?'s':''} available` : 'No words found â€” add some in content.js';
    }

    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('newGameBtn').onclick = showSetup;

    function showSetup() {
      document.getElementById('winOverlay').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'flex';
      document.getElementById('gameScreen').classList.remove('active');
    }

    function startGame() {
      numTeams = selTeams;
      teams = Array.from({length:numTeams}, (_, i) => ({
        name: document.getElementById(`tname${i}`)?.value || `Team ${i+1}`,
        color: TEAM_COLORS[i],
        roundScore: 0,
        totalScore: 0,
      }));
      currentTeam = 0;

      // Build phrase pool
      const topic = document.getElementById('topicSelect').value;
      const words = window.CUSTOM_CONTENT?.words || [];
      phrasePool = words.filter(w => !topic || w.topic === topic).map(w => w.word);
      if (!phrasePool.length) {
        // Fallback built-in phrases
        phrasePool = ['WHEEL OF FORTUNE','PASSIVE VOICE','CONDITIONAL SENTENCE','METAPHOR AND SIMILE',
          'PRESENT PERFECT TENSE','REPORTED SPEECH','FIGURATIVE LANGUAGE','ADJECTIVE CLAUSE',
          'SUBORDINATE CONJUNCTION','CHARACTERISATION'];
      }
      phrasePool = shuffle([...phrasePool]);

      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('gameScreen').classList.add('active');
      drawWheel();
      buildScoreCards();
      newPhrase();
    }

    // â”€â”€ Phrase management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let phraseIndex = 0;
    function newPhrase() {
      document.getElementById('winOverlay').style.display = 'none';
      if (phraseIndex >= phrasePool.length) {
        phrasePool = shuffle([...phrasePool]); phraseIndex = 0;
      }
      phrase = phrasePool[phraseIndex++].toUpperCase();
      usedLetters = new Set();
      // Reset round scores
      teams.forEach(t => t.roundScore = 0);
      currentWheelValue = 0; currentWheelType = ''; hasFreeSpinStored = false;
      document.getElementById('resultBanner').style.display = 'none';
      document.getElementById('letterSection').style.display = 'none';
      document.getElementById('guessSection').style.display = 'none';
      document.getElementById('guessInput').value = '';
      document.getElementById('spinBtn').disabled = false;
      renderPhrase();
      buildLetterBtns();
      buildScoreCards();
      updateStatus();
      document.getElementById('phraseCategory').textContent =
        document.getElementById('topicSelect').value || 'Word / Phrase';
    }

    // â”€â”€ Phrase render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPhrase(solvedBy) {
      const board = document.getElementById('phraseBoard');
      board.innerHTML = '';
      phrase.split(' ').forEach(word => {
        const wordEl = document.createElement('div'); wordEl.className = 'wof-word';
        word.split('').forEach(ch => {
          const tile = document.createElement('div');
          tile.className = 'wof-tile';
          const isLetter = /[A-Z]/.test(ch);
          if (!isLetter) {
            tile.textContent = ch; tile.style.background='transparent'; tile.style.border='none';
            tile.style.color='white';
          } else if (usedLetters.has(ch) || solvedBy) {
            tile.classList.add(solvedBy ? 'solved' : 'revealed');
            tile.textContent = ch;
          }
          wordEl.appendChild(tile);
        });
        board.appendChild(wordEl);
      });
    }

    // â”€â”€ Letter buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildLetterBtns() {
      const el = document.getElementById('letterBtns'); el.innerHTML = '';
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(ch => {
        const btn = document.createElement('button');
        btn.className = 'wof-letter-btn'; btn.textContent = ch;
        btn.onclick = () => pickLetter(ch);
        btn.id = `lbtn-${ch}`;
        el.appendChild(btn);
      });
    }

    function updateLetterBtns() {
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(ch => {
        const btn = document.getElementById(`lbtn-${ch}`);
        if (!btn) return;
        if (usedLetters.has(ch)) {
          btn.disabled = true;
          btn.classList.add(phrase.includes(ch) ? 'used-hit' : 'used-miss');
        } else {
          btn.disabled = false;
          btn.classList.remove('used-hit','used-miss');
        }
      });
    }

    // â”€â”€ Score cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildScoreCards() {
      const el = document.getElementById('scoreCards'); el.innerHTML = '';
      teams.forEach((t, i) => {
        const card = document.createElement('div');
        card.className = 'wof-score-card' + (i===currentTeam?' current':'');
        card.id = `sc-${i}`;
        card.style.borderColor = i===currentTeam ? t.color : '';
        card.innerHTML = `
          <div class="sc-name" style="color:${t.color}">${t.name}</div>
          <div class="sc-round" id="sc-round-${i}">Â£${t.roundScore}</div>
          <div class="sc-total" id="sc-total-${i}">Total: Â£${t.totalScore}</div>`;
        el.appendChild(card);
      });
    }

    function updateScoreCards() {
      teams.forEach((t, i) => {
        const card = document.getElementById(`sc-${i}`);
        if (!card) return;
        card.className = 'wof-score-card' + (i===currentTeam?' current':'');
        card.style.borderColor = i===currentTeam ? t.color : '';
        document.getElementById(`sc-round-${i}`).textContent = `Â£${t.roundScore}`;
        document.getElementById(`sc-total-${i}`).textContent = `Total: Â£${t.totalScore}`;
      });
    }

    // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateStatus(msg) {
      const t = teams[currentTeam];
      const el = document.getElementById('statusBar');
      el.textContent = msg || `${t.name} â€” Spin the wheel!`;
      el.style.color = t.color;
    }

    // â”€â”€ Wheel draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawWheel(highlightIdx) {
      const canvas = document.getElementById('wheelCanvas');
      const ctx = canvas.getContext('2d');
      const cx = canvas.width/2, cy = canvas.height/2, r = cx - 6;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      SEGMENTS.forEach((seg, i) => {
        const startAngle = i * SLICE - Math.PI/2;
        const endAngle   = startAngle + SLICE;
        // Slice
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = i===highlightIdx ? '#ffffff22' : seg.color;
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Text
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(startAngle + SLICE/2);
        ctx.textAlign = 'right';
        ctx.fillStyle = seg.type==='bankrupt' ? '#ff6b6b' :
                        seg.type==='loseturn'  ? '#9ca3af' :
                        seg.type==='freespin'  ? '#fbbf24' :
                        seg.type==='double'    ? '#c084fc' : '#ffffff';
        const lines = seg.label.split('\n');
        const fsize = lines.length > 1 ? Math.min(12, r*0.12) : Math.min(13, r*0.13);
        ctx.font = `900 ${fsize}px Segoe UI, Arial`;
        if (lines.length === 1) {
          ctx.fillText(seg.label, r - 10, fsize/3);
        } else {
          ctx.fillText(lines[0], r-10, -fsize*0.3);
          ctx.fillText(lines[1], r-10,  fsize*0.9);
        }
        ctx.restore();
      });

      // Centre circle
      ctx.beginPath();
      ctx.arc(cx, cy, 22, 0, 2*Math.PI);
      ctx.fillStyle = '#0f2027';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.4)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.fillStyle = 'white';
      ctx.font = '900 14px Segoe UI';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('SPIN', cx, cy);
    }

    // â”€â”€ Spin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let wheelAngle = 0;
    function spinWheel() {
      if (spinning) return;
      spinning = true;
      document.getElementById('spinBtn').disabled = true;
      document.getElementById('letterSection').style.display = 'none';
      document.getElementById('guessSection').style.display = 'none';
      document.getElementById('resultBanner').style.display = 'none';

      playSpinStart();
      const extraSpins = 5 + Math.random() * 5;
      const targetAngle = wheelAngle + extraSpins * 2 * Math.PI;
      const duration = 3000 + Math.random() * 1500;
      const start = performance.now();
      const startAngle = wheelAngle;

      function animate(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        // Ease out
        const ease = 1 - Math.pow(1 - progress, 4);
        wheelAngle = startAngle + (targetAngle - startAngle) * ease;

        // Draw rotated wheel
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const cx = canvas.width/2, cy = canvas.height/2;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(wheelAngle);
        ctx.translate(-cx, -cy);
        drawWheel();
        ctx.restore();
        // Redraw centre text on top
        ctx.beginPath();
        ctx.arc(cx,cy,22,0,2*Math.PI);
        ctx.fillStyle='#0f2027'; ctx.fill();
        ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle='white'; ctx.font='900 14px Segoe UI';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('SPIN',cx,cy);

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // Determine which segment the pointer (top, -PI/2) points to
          // Pointer is at top = angle 0 on static wheel = -PI/2 in canvas space
          // The wheel has rotated by wheelAngle, so the segment at the pointer
          // is the one at angle -wheelAngle mod 2PI
          const normalised = ((-wheelAngle % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
          const idx = Math.floor(normalised / SLICE) % N;
          landOn(SEGMENTS[idx]);
          spinning = false;
        }
      }
      requestAnimationFrame(animate);
    }

    function landOn(seg) {
      playSpinStop();
      currentWheelType  = seg.type;
      currentWheelValue = seg.value;

      const banner = document.getElementById('resultBanner');
      banner.style.display = 'block';

      if (seg.type === 'bankrupt') {
        teams[currentTeam].roundScore = 0;
        updateScoreCards();
        banner.className = 'wof-result result-bankrupt';
        banner.textContent = 'ğŸ’€ BANKRUPT! Â£0';
        playBankrupt();
        setTimeout(() => nextTurn('BANKRUPT â€” lost all round points!'), 2000);

      } else if (seg.type === 'loseturn') {
        banner.className = 'wof-result result-lose';
        banner.textContent = 'â­ LOSE A TURN';
        playLose();
        setTimeout(() => nextTurn('Lost their turn!'), 2000);

      } else if (seg.type === 'freespin') {
        hasFreeSpinStored = true;
        banner.className = 'wof-result result-free';
        banner.textContent = 'ğŸŸ FREE SPIN!';
        playFree();
        setTimeout(() => {
          banner.style.display = 'none';
          document.getElementById('letterSection').style.display = 'block';
          document.getElementById('guessSection').style.display = 'block';
          document.getElementById('spinBtn').disabled = false;
          updateStatus(`${teams[currentTeam].name} â€” FREE SPIN! Pick a letter or spin again`);
        }, 1500);

      } else if (seg.type === 'double') {
        banner.className = 'wof-result result-double';
        banner.textContent = 'âœ¨ DOUBLE POINTS next letter!';
        playDouble();
        setTimeout(() => {
          banner.style.display = 'none';
          document.getElementById('letterSection').style.display = 'block';
          document.getElementById('guessSection').style.display = 'block';
          updateStatus(`${teams[currentTeam].name} â€” DOUBLE! Pick a letter`);
        }, 1500);

      } else {
        // Points
        banner.className = 'wof-result result-points';
        banner.textContent = `${seg.label} per letter!`;
        playPoints(seg.value);
        setTimeout(() => {
          banner.style.display = 'none';
          document.getElementById('letterSection').style.display = 'block';
          document.getElementById('guessSection').style.display = 'block';
          updateStatus(`${teams[currentTeam].name} â€” Pick a letter! (${seg.label} each)`);
        }, 1200);
      }
    }

    // â”€â”€ Pick a letter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function pickLetter(ch) {
      if (usedLetters.has(ch)) return;
      usedLetters.add(ch);
      updateLetterBtns();
      document.getElementById('letterSection').style.display = 'none';
      document.getElementById('guessSection').style.display = 'none';

      const count = phrase.split('').filter(c => c === ch).length;
      const banner = document.getElementById('resultBanner');
      banner.style.display = 'block';

      if (count === 0) {
        // Miss
        banner.className = 'wof-result result-lose';
        banner.textContent = `No ${ch} â€” miss!`;
        playMiss();
        renderPhrase();
        setTimeout(() => nextTurn(`No "${ch}" in the phrase`), 1800);
      } else {
        // Hit
        let earned = (currentWheelType==='double' ? currentWheelValue*2 : currentWheelValue) * count;
        teams[currentTeam].roundScore += earned;
        updateScoreCards();
        banner.className = 'wof-result result-points';
        banner.textContent = `${count}Ã— ${ch}! +Â£${earned} ğŸ‰`;
        playHit(count);
        renderPhrase();

        // Check if phrase fully revealed
        const letters = phrase.replace(/[^A-Z]/g,'').split('');
        const allRevealed = letters.every(c => usedLetters.has(c));
        if (allRevealed) {
          setTimeout(() => phraseCompleted(currentTeam, false), 1200);
        } else {
          setTimeout(() => {
            banner.style.display = 'none';
            // Stay on same team, spin again
            document.getElementById('spinBtn').disabled = false;
            document.getElementById('guessSection').style.display = 'block';
            updateStatus(`${teams[currentTeam].name} â€” Spin again or guess the phrase!`);
          }, 1800);
        }
      }
    }

    // â”€â”€ Guess the phrase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function submitGuess() {
      const input = document.getElementById('guessInput');
      const guess = input.value.trim().toUpperCase();
      if (!guess) return;
      input.value = '';
      document.getElementById('guessSection').style.display = 'none';
      document.getElementById('spinBtn').disabled = true;

      const banner = document.getElementById('resultBanner');
      banner.style.display = 'block';

      if (guess === phrase) {
        // Correct â€” bonus = round score again (double it)
        const bonus = Math.max(teams[currentTeam].roundScore, 500);
        teams[currentTeam].roundScore += bonus;
        banner.className = 'wof-result result-points';
        banner.textContent = `âœ… CORRECT! +Â£${bonus} bonus!`;
        playWin();
        renderPhrase();
        setTimeout(() => phraseCompleted(currentTeam, true), 1500);
      } else {
        // Wrong â€” lose round points
        const lost = teams[currentTeam].roundScore;
        teams[currentTeam].roundScore = 0;
        updateScoreCards();
        banner.className = 'wof-result result-bankrupt';
        banner.textContent = `âœ— Wrong! Lost Â£${lost}`;
        playBankrupt();
        setTimeout(() => nextTurn(`Wrong guess â€” lost Â£${lost}!`), 2000);
      }
    }

    // â”€â”€ Phrase completed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function phraseCompleted(teamIdx, byGuess) {
      const team = teams[teamIdx];
      // Bank round score
      team.totalScore += team.roundScore;
      team.roundScore = 0;
      updateScoreCards();
      // Reveal all
      renderPhrase('solved');
      playWin();
      document.getElementById('winOverlay').style.display = 'flex';
      document.getElementById('winMsg').textContent = `${team.name} solves it! ğŸ‰`;
      document.getElementById('winDetail').textContent =
        byGuess ? `Solved by guessing! Total: Â£${team.totalScore}` :
                  `All letters revealed! Total: Â£${team.totalScore}`;
      // Move to next team after win
      currentTeam = (currentTeam + 1) % numTeams;
    }

    // â”€â”€ Next turn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function nextTurn(reason) {
      document.getElementById('resultBanner').style.display = 'none';
      document.getElementById('spinBtn').disabled = false;
      currentTeam = (currentTeam + 1) % numTeams;
      updateScoreCards();
      updateStatus(`${teams[currentTeam].name} â€” Spin the wheel!`);
    }

    // â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let actx = null;
    function ac() { if (!actx) actx = new (window.AudioContext||window.webkitAudioContext)(); return actx; }

    function playSpinStart() {
      const ctx=ac(), t=ctx.currentTime;
      const o=ctx.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(200,t); o.frequency.exponentialRampToValueAtTime(600,t+0.3);
      const g=ctx.createGain(); g.gain.setValueAtTime(0.15,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.3);
    }

    function playSpinStop() {
      const ctx=ac(), t=ctx.currentTime;
      const o=ctx.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(500,t); o.frequency.exponentialRampToValueAtTime(180,t+0.4);
      const g=ctx.createGain(); g.gain.setValueAtTime(0.2,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.4);
    }

    function playPoints(val) {
      const ctx=ac(), t=ctx.currentTime;
      const freq = 300 + val/4;
      const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
      const g=ctx.createGain(); g.gain.setValueAtTime(0.3,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.3);
    }

    function playHit(count) {
      const ctx=ac();
      for (let i=0;i<Math.min(count,5);i++) {
        const t=ctx.currentTime+i*0.12;
        const o=ctx.createOscillator(); o.type='triangle';
        o.frequency.value=523+(i*80);
        const g=ctx.createGain(); g.gain.setValueAtTime(0.3,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
        o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.2);
      }
    }

    function playMiss() {
      const ctx=ac(), t=ctx.currentTime;
      [220,180].forEach((f,i)=>{
        const st=t+i*0.15;
        const o=ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=f;
        const g=ctx.createGain(); g.gain.setValueAtTime(0.25,st); g.gain.exponentialRampToValueAtTime(0.001,st+0.2);
        o.connect(g); g.connect(ctx.destination); o.start(st); o.stop(st+0.2);
      });
    }

    function playBankrupt() {
      const ctx=ac(), t=ctx.currentTime;
      const o=ctx.createOscillator(); o.type='sawtooth';
      o.frequency.setValueAtTime(300,t); o.frequency.exponentialRampToValueAtTime(50,t+0.8);
      const g=ctx.createGain(); g.gain.setValueAtTime(0.4,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.8);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.8);
    }

    function playLose() {
      const ctx=ac(), t=ctx.currentTime;
      const o=ctx.createOscillator(); o.type='triangle';
      o.frequency.setValueAtTime(330,t); o.frequency.setValueAtTime(220,t+0.2);
      const g=ctx.createGain(); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.4);
    }

    function playFree() {
      const ctx=ac();
      [523,659,784].forEach((f,i)=>{
        const t=ctx.currentTime+i*0.1;
        const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=f;
        const g=ctx.createGain(); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.25);
        o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.25);
      });
    }

    function playDouble() {
      const ctx=ac();
      [440,550,660,880].forEach((f,i)=>{
        const t=ctx.currentTime+i*0.1;
        const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=f;
        const g=ctx.createGain(); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
        o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.2);
      });
    }

    function playWin() {
      const ctx=ac();
      [523,659,784,1047,1319].forEach((f,i)=>{
        const t=ctx.currentTime+i*0.13;
        const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=f;
        const g=ctx.createGain(); g.gain.setValueAtTime(0.35,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
        o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.4);
      });
    }

    // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shuffle(arr) {
      for (let i=arr.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadTopics();
    drawWheel();
  </script>
</body>
</html>
