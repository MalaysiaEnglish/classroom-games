<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grammar Cards</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .setup-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 40px 20px;
      text-align: center;
    }
    .setup-screen h2 {
      font-size: clamp(1.4em, 4vw, 2em);
      text-shadow: 2px 2px 6px #000;
    }
    .team-picker {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .team-picker button {
      width: 70px;
      height: 70px;
      font-size: 1.8em;
      font-weight: 900;
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      color: #333;
      border: 4px solid transparent;
      transition: all 0.2s;
    }
    .team-picker button.selected {
      background: #50c878;
      color: white;
      border-color: #fff;
      transform: scale(1.1);
    }
    .start-btn {
      padding: 14px 40px;
      font-size: 1.3em;
      background: #50c878;
      color: white;
      border: none;
      border-radius: 40px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .start-btn:hover { background: #45a863; }
    .good { background: #50c878 !important; color: white !important; }
    .bad  { background: #ef4444 !important; color: white !important; }
  </style>
</head>

<body>
  <h1>Grammar Cards</h1>

  <div class="controls">
    <button id="newGame">New Game</button>
    <button id="fullscreen">Fullscreen</button>
    <button id="home">Home</button>
  </div>

  <div class="game-wrapper" id="gameWrapper">

    <!-- SETUP SCREEN -->
    <div class="setup-screen" id="setupScreen">
      <h2>How many teams?</h2>
      <div class="team-picker" id="teamPicker">
        <button data-n="2">2</button>
        <button data-n="3">3</button>
        <button data-n="4" class="selected">4</button>
        <button data-n="5">5</button>
        <button data-n="6">6</button>
      </div>
      <button class="start-btn" id="startBtn">▶ Start Game</button>
    </div>

    <!-- GAME AREA (hidden until started) -->
    <div id="gameArea" style="display:none; width:100%; display:none; flex-direction:column; align-items:center;">
      <div id="currentTurn">Click "New Game" to start</div>
      <div class="row" id="row"></div>
      <div class="controls" style="margin-top:0;">
        <button class="bad"  id="wrongBtn"   disabled>✘ Sentence Wrong</button>
        <button class="good" id="higherBtn"  disabled>⬆ Higher</button>
        <button class="bad"  id="lowerBtn"   disabled>⬇ Lower</button>
      </div>
      <div class="scoreboard" id="scoreboard"></div>
    </div>

  </div>

  <script>
    const rowEl         = document.getElementById('row');
    const currentTurnEl = document.getElementById('currentTurn');
    const scoreboard    = document.getElementById('scoreboard');
    const setupScreen   = document.getElementById('setupScreen');
    const gameArea      = document.getElementById('gameArea');

    let deck = [], rowCards = [], revealedUpTo = -1;
    let awaitingSentence = false, awaitingGuess = false;
    let numTeams = 4, teamScores = [], currentTeam = 0;
    let firstCardRevealed = false;
    let selectedTeams = 4;

    // Team picker
    document.querySelectorAll('#teamPicker button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#teamPicker button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedTeams = parseInt(btn.dataset.n);
      });
    });

    document.getElementById('startBtn').onclick = () => startGame(selectedTeams);
    document.getElementById('newGame').onclick   = () => {
      setupScreen.style.display = 'flex';
      gameArea.style.display    = 'none';
    };

    function startGame(n) {
      numTeams    = n;
      teamScores  = new Array(n).fill(0);
      currentTeam = 0;
      deck        = shuffle(buildDeck());
      setupScreen.style.display = 'none';
      gameArea.style.display    = 'flex';
      updateStats();
      dealRow();
    }

    const ranks       = '23456789TJQKA';
    const suitSymbols = ['♠','♥','♦','♣'];
    const suitColors  = { '♠':'black','♥':'red','♦':'red','♣':'black' };

    function buildDeck() {
      const c = [];
      for (let r of ranks)
        for (let s of suitSymbols)
          c.push({ rank: r === 'T' ? '10' : r, suit: s, value: ranks.indexOf(r) + 2 });
      return c;
    }

    function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

    function renderCard(card, faceDown = false) {
      const d = document.createElement('div');
      d.className = 'card' + (faceDown ? ' face-down' : '');
      if (faceDown) {
        d.innerHTML = '<div style="font-size:3rem;color:white">?</div>';
      } else {
        const col = suitColors[card.suit];
        d.innerHTML = `
          <div class="corner top" style="color:${col}">${card.rank}<br>${card.suit}</div>
          <div class="big-rank"   style="color:${col}">${card.rank}</div>
          <div class="suit-big"   style="color:${col}">${card.suit}</div>
          <div class="corner bottom" style="color:${col}">${card.rank}<br>${card.suit}</div>`;
      }
      return d;
    }

    function updateStats() {
      scoreboard.innerHTML = '';
      teamScores.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'team-score' + (i === currentTeam ? ' active' : '');
        div.innerHTML = `Team ${i+1}<br>${s}`;
        scoreboard.appendChild(div);
      });
    }

    function renderRow() {
      rowEl.innerHTML = '';
      rowCards.forEach((c, i) => rowEl.appendChild(renderCard(c, i > revealedUpTo)));
    }

    function dealRow() {
      if (deck.length < 15) deck = shuffle(buildDeck());
      rowCards     = deck.splice(0, 15);
      revealedUpTo = 0;
      renderRow();
      awaitingSentence = false;
      awaitingGuess    = true;
      document.getElementById('wrongBtn').disabled   = false;
      document.getElementById('higherBtn').disabled  = false;
      document.getElementById('lowerBtn').disabled   = false;
      currentTurnEl.textContent = `Team ${currentTeam + 1} — Higher or Lower? (✘ if sentence was wrong)`;
      updateStats();
    }


    document.getElementById('wrongBtn').onclick = () => {
      // Wrong sentence — pass to next team, no points awarded
      currentTeam = (currentTeam + 1) % numTeams;
      awaitingSentence = false;
      awaitingGuess    = true;
      document.getElementById('wrongBtn').disabled   = false;
      document.getElementById('higherBtn').disabled  = false;
      document.getElementById('lowerBtn').disabled   = false;
      updateStats();
      currentTurnEl.textContent = `Team ${currentTeam + 1} — Higher or Lower? (✘ if sentence was wrong)`;
    };

    function doGuess(higher) {
      if (!awaitingGuess) return;
      awaitingGuess = false;
      document.getElementById('higherBtn').disabled = true;
      document.getElementById('lowerBtn').disabled  = true;
      setTimeout(() => {
        const prev    = rowCards[revealedUpTo];
        revealedUpTo++;
        renderRow();
        const next    = rowCards[revealedUpTo];
        const correct = (higher && next.value > prev.value) ||
                        (!higher && next.value < prev.value);
        if (revealedUpTo === 14) {
          // Last card revealed — end of row
          if (correct) {
            teamScores[currentTeam] += 20;
            currentTurnEl.textContent = `CORRECT! Row complete! Team ${currentTeam + 1} gets +20 bonus!`;
          } else {
            currentTurnEl.textContent = `WRONG! Row complete! New row coming...`;
            currentTeam = (currentTeam + 1) % numTeams;
          }
          updateStats();
          setTimeout(dealRow, 3000);
          return;
        }
        if (correct) {
          // Correct guess: +10, same team, straight to next Higher/Lower
          teamScores[currentTeam] += 10;
          updateStats();
          awaitingGuess = true;
          document.getElementById('wrongBtn').disabled   = false;
          document.getElementById('higherBtn').disabled  = false;
          document.getElementById('lowerBtn').disabled   = false;
          currentTurnEl.textContent = `✔ CORRECT! +10 — Team ${currentTeam + 1} — Higher or Lower? (✘ if sentence wrong)`;
        } else {
          // Wrong guess: next team, no points
          currentTeam = (currentTeam + 1) % numTeams;
          updateStats();
          awaitingGuess = true;
          document.getElementById('wrongBtn').disabled   = false;
          document.getElementById('higherBtn').disabled  = false;
          document.getElementById('lowerBtn').disabled   = false;
          currentTurnEl.textContent = `✘ WRONG! Team ${currentTeam + 1} — Higher or Lower? (✘ if sentence wrong)`;
        }
      }, 700);
    }

    document.getElementById('higherBtn').onclick = () => doGuess(true);
    document.getElementById('lowerBtn').onclick  = () => doGuess(false);
    document.getElementById('fullscreen').onclick = () => document.documentElement.requestFullscreen?.();
    document.getElementById('home').onclick       = () => window.location.href = '../index.html';
  </script>
</body>
</html>
