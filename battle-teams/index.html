<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Battle Teams</title>
  <link rel="stylesheet" href="../style.css">
</head>

<body>
  <h1>Battle Teams</h1>

  <div class="controls">
    <label>Cols: <input type="number" id="cols" min="4" max="12" value="6"></label>
    <label>Rows: <input type="number" id="rows" min="4" max="5" value="5"></label>
    <label>Teams: <input type="number" id="teams" min="3" max="10" value="6"></label>
    <button id="build">New Game</button>
    <button id="reset">Reset Tiles</button>
    <button id="skipTurn">‚è≠ Skip Team</button>
    <button id="fullscreen">Fullscreen</button>
    <button id="home">Home</button>
  </div>

  <!-- ‚úÖ Everything below is now inside the unified wrapper -->
  <div class="game-wrapper">

    <div id="currentTurn">Team 1's Turn!</div>

    <div class="grid" id="grid"></div>

    <div class="scoreboard" id="scoreboard"></div>

    <!-- ‚úÖ Unified Modal -->
    <div id="targetModal" class="modal-overlay">
      <div class="modal-box">
        <h2 id="modalMessage">Choose a team</h2>
        <div id="modalButtons" class="modal-buttons"></div>
        <button onclick="closeModal()" class="modal-cancel">Cancel</button>
      </div>
    </div>

  </div> <!-- end wrapper -->

  <script>
    const gridEl = document.getElementById("grid");
    const scoreboard = document.getElementById("scoreboard");
    const currentTurnEl = document.getElementById("currentTurn");

    // ‚úÖ REAL EMOJI ICONS
    const emojis = {
      heart: '‚ù§Ô∏è',
      safe: 'üõ°Ô∏è',
      skull: 'üíÄ',
      dynamite: 'üí£',
      steal: 'üí∞',
      pistol: 'üî´',
      swap: 'üîÑ',
      wings: 'ü™Ω',
      twoX: '2Ô∏è‚É£√ó',
      threeX: '3Ô∏è‚É£√ó'
    };

    let teamSafe = [];
    let currentTeam = 0;
    let totalTeams = 0;

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateSymbolPool(size) {
      let pool = ['safe'];
      const probs = {
        heart: 0.22, skull: 0.05, dynamite: 0.05, steal: 0.05, pistol: 0.05,
        swap: 0.03, wings: 0.03, twoX: 0.02, threeX: 0.02
      };
      for (let sym in probs) {
        let count = Math.round(size * probs[sym]);
        for (let i = 0; i < count; i++) pool.push(sym);
      }
      while (pool.length < size) pool.push('heart');
      return shuffle(pool);
    }

    function resetCovers() {
      document.querySelectorAll('.cover').forEach(c => c.classList.remove('hidden'));
      document.querySelectorAll('.symbol').forEach(s => s.remove());
    }

    function highlightActiveTeam() {
      document.querySelectorAll('.team-container').forEach((c, i) =>
        c.classList.toggle('active-team', i === currentTeam)
      );
      currentTurnEl.textContent = `Team ${currentTeam + 1}'s Turn!`;
    }

    function updateSafeIndicators() {
      document.querySelectorAll('.safe-indicator').forEach((e, i) =>
        e.textContent = teamSafe[i] ? 'üõ°Ô∏è' : ''
      );
    }

    // ‚úÖ Unified modal system
    function showTargetModal(message, callback) {
      document.getElementById('modalMessage').textContent = message;
      const buttonsDiv = document.getElementById('modalButtons');
      buttonsDiv.innerHTML = '';

      let hasTarget = false;
      for (let i = 0; i < totalTeams; i++) {
        if (i !== currentTeam && !teamSafe[i]) {
          hasTarget = true;
          const btn = document.createElement('button');
          btn.textContent = `Team ${i + 1}`;
          btn.onclick = () => {
            closeModal();
            callback(i);
          };
          buttonsDiv.appendChild(btn);
        }
      }

      if (!hasTarget) {
        alert("No valid targets!");
        callback(null);
      } else {
        document.getElementById('targetModal').classList.add('show');
      }
    }

    function closeModal() {
      document.getElementById('targetModal').classList.remove('show');
    }

    function getSymbolText(sym) {
      const map = {
        heart: '+1 Point', safe: 'SAFE!', skull: '-3 Points', dynamite: 'BOMB!',
        steal: 'STEAL 3', pistol: 'SHOOT -2', swap: 'SWAP!', wings: 'DOUBLE!',
        twoX: '√ó2 SCORE', threeX: '√ó3 SCORE'
      };
      return map[sym] || sym.toUpperCase();
    }

    function applySymbol(teamIndex, symbol, done) {
      const inputs = document.querySelectorAll('.scoreboard input');
      let score = parseInt(inputs[teamIndex].value) || 0;

      const tile = event.target.closest('.tile');
      const symDiv = document.createElement('div');
      symDiv.className = 'symbol';
      symDiv.innerHTML = `${emojis[symbol]}<div class="symbol-text">${getSymbolText(symbol)}</div>`;
      tile.appendChild(symDiv);

      switch (symbol) {
        case 'heart': score += 1; inputs[teamIndex].value = score; done(); break;
        case 'safe': teamSafe[teamIndex] = true; updateSafeIndicators(); done(); break;
        case 'skull': score -= 3; inputs[teamIndex].value = score; done(); break;

        case 'dynamite':
          showTargetModal(`Team ${teamIndex + 1} found BOMB! Choose a team to wipe their score to zero:`,
            i => { if (i !== null) inputs[i].value = 0; done(); });
          return;

        case 'steal':
          showTargetModal(`Team ${teamIndex + 1} found STEAL! Choose team to steal 3 points from:`,
            i => {
              if (i === null) return done();
              let v = parseInt(inputs[i].value) || 0;
              const stolen = Math.min(3, v);
              inputs[teamIndex].value = score + stolen;
              inputs[i].value = v - stolen;
              done();
            });
          return;

        case 'pistol':
          showTargetModal(`Team ${teamIndex + 1} found PISTOL! Choose team to shoot (-2):`,
            i => { if (i !== null) inputs[i].value = (parseInt(inputs[i].value)||0)-2; done(); });
          return;

        case 'swap':
          showTargetModal(`Team ${teamIndex + 1} found SWAP! Choose team to swap scores with:`,
            i => {
              if (i === null) return done();
              const temp = inputs[i].value;
              inputs[i].value = score;
              inputs[teamIndex].value = temp;
              done();
            });
          return;

        case 'wings':
          showTargetModal(`Team ${teamIndex + 1} found WINGS! Choose team to DOUBLE score:`,
            i => {
              if (i !== null) {
                const s = parseInt(inputs[i].value) || 0;
                if (s > 0) inputs[i].value = s * 2;
              }
              done();
            });
          return;

        case 'twoX': if (score > 0) score *= 2; inputs[teamIndex].value = score; done(); break;
        case 'threeX': if (score > 0) score *= 3; inputs[teamIndex].value = score; done(); break;
      }
    }

    function buildGrid() {
      const cols = clamp(parseInt(document.getElementById('cols').value) || 6, 4, 12);
      const rows = clamp(parseInt(document.getElementById('rows').value) || 5, 4, 5);
      totalTeams = clamp(parseInt(document.getElementById('teams').value) || 6, 3, 10);

      document.documentElement.style.setProperty('--cols', cols);
      document.documentElement.style.setProperty('--rows', rows);

      const pool = generateSymbolPool(cols * rows);
      gridEl.innerHTML = '';
      let num = 1;

      pool.forEach(sym => {
        const tile = document.createElement('div');
        tile.className = 'tile';

        const cover = document.createElement('div');
        cover.className = 'cover';
        cover.textContent = num++;

        cover.onclick = function () {
          cover.classList.add('hidden');
          applySymbol(currentTeam, sym, () => {
            currentTeam = (currentTeam + 1) % totalTeams;
            highlightActiveTeam();
          });
        };

        tile.appendChild(cover);
        gridEl.appendChild(tile);
      });

      scoreboard.innerHTML = '';
      teamSafe = new Array(totalTeams).fill(false);

      for (let i = 0; i < totalTeams; i++) {
        const container = document.createElement('div');
        container.className = 'team-container';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'team-name';
        nameDiv.innerHTML = `Team ${i + 1} <span class="safe-indicator"></span>`;

        const inp = document.createElement('input');
        inp.type = 'number';
        inp.value = 0;

        container.appendChild(nameDiv);
        container.appendChild(inp);
        scoreboard.appendChild(container);
      }

      currentTeam = 0;
      highlightActiveTeam();
      updateSafeIndicators();
    }

    document.getElementById('build').onclick = buildGrid;
    document.getElementById('reset').onclick = resetCovers;
    document.getElementById('skipTurn').onclick = () => {
      currentTeam = (currentTeam + 1) % totalTeams;
      highlightActiveTeam();
    };
    document.getElementById('fullscreen').onclick = () => document.documentElement.requestFullscreen?.();
    document.getElementById('home').onclick = () => window.location.href = '../index.html';

    buildGrid();
  </script>

</body>
</html>